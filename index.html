<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒ³ãƒ—ãƒ«å‰²ã‚Šå‹˜è¨ˆç®—æ©Ÿ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        .payment-item {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-btn {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        .result {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .settlement {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§® ã‚·ãƒ³ãƒ—ãƒ«å‰²ã‚Šå‹˜è¨ˆç®—æ©Ÿ</h1>
        
        <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="form-group">
            <label for="payerName">æ”¯æ‰•ã£ãŸäºº:</label>
            <input type="text" id="payerName" placeholder="ä¾‹: ç”°ä¸­">
        </div>
        
        <div class="form-group">
            <label for="description">å†…å®¹:</label>
            <input type="text" id="description" placeholder="ä¾‹: ãƒ©ãƒ³ãƒä»£">
        </div>
        
        <div class="form-group">
            <label for="amount">é‡‘é¡:</label>
            <input type="number" id="amount" placeholder="ä¾‹: 3000">
        </div>
        
        <button onclick="addPayment()">æ”¯æ‰•ã„ã‚’è¿½åŠ </button>
        <button onclick="clearAll()">å…¨ã¦å‰Šé™¤</button>
        
        <!-- æ”¯æ‰•ã„ä¸€è¦§ -->
        <h2>ğŸ“ æ”¯æ‰•ã„è¨˜éŒ²</h2>
        <div id="paymentsList">
            <div class="empty">ã¾ã æ”¯æ‰•ã„è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
        
        <!-- è¨ˆç®—ãƒœã‚¿ãƒ³ -->
        <div id="calculateSection" style="display: none;">
            <button onclick="calculateSettlement()" style="background-color: #28a745; font-size: 18px; padding: 15px 30px;">
                ğŸ’° ç²¾ç®—ã‚’è¨ˆç®—ã™ã‚‹
            </button>
        </div>
        
        <!-- çµæœè¡¨ç¤º -->
        <div id="resultSection" style="display: none;">
            <h2>ğŸ’ ç²¾ç®—çµæœ</h2>
            <div id="totalInfo" class="result"></div>
            <div id="settlementList"></div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let payments = [];
        let members = new Set();

        // æ”¯æ‰•ã„ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addPayment() {
            console.log('addPaymenté–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
            
            const payerName = document.getElementById('payerName').value.trim();
            const description = document.getElementById('description').value.trim();
            const amount = parseInt(document.getElementById('amount').value);

            console.log('å…¥åŠ›å€¤:', { payerName, description, amount });

            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!payerName) {
                alert('æ”¯æ‰•ã£ãŸäººã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!description) {
                alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!amount || amount <= 0 || isNaN(amount)) {
                alert('æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // æ”¯æ‰•ã„è¨˜éŒ²ã‚’ä½œæˆ
            const payment = {
                id: Date.now(),
                payer: payerName,
                description: description,
                amount: amount
            };

            // é…åˆ—ã«è¿½åŠ 
            payments.push(payment);
            members.add(payerName);

            console.log('æ”¯æ‰•ã„è¿½åŠ :', payment);
            console.log('ç¾åœ¨ã®æ”¯æ‰•ã„ä¸€è¦§:', payments);

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('payerName').value = '';
            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';

            // ç”»é¢ã‚’æ›´æ–°
            updateDisplay();
            
            alert('æ”¯æ‰•ã„ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
        }

        // æ”¯æ‰•ã„ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function removePayment(paymentId) {
            console.log('å‰Šé™¤ID:', paymentId);
            
            payments = payments.filter(p => p.id !== paymentId);
            
            // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’å†æ§‹ç¯‰
            members.clear();
            payments.forEach(p => members.add(p.payer));
            
            console.log('å‰Šé™¤å¾Œã®æ”¯æ‰•ã„ä¸€è¦§:', payments);
            
            updateDisplay();
            alert('æ”¯æ‰•ã„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // å…¨ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤
        function clearAll() {
            if (confirm('å…¨ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                payments = [];
                members.clear();
                updateDisplay();
                alert('å…¨ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // ç”»é¢è¡¨ç¤ºã‚’æ›´æ–°
        function updateDisplay() {
            console.log('updateDisplayé–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
            
            const paymentsList = document.getElementById('paymentsList');
            const calculateSection = document.getElementById('calculateSection');
            const resultSection = document.getElementById('resultSection');
            
            // æ”¯æ‰•ã„ä¸€è¦§ã‚’æ›´æ–°
            if (payments.length === 0) {
                paymentsList.innerHTML = '<div class="empty">ã¾ã æ”¯æ‰•ã„è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                calculateSection.style.display = 'none';
                resultSection.style.display = 'none';
            } else {
                paymentsList.innerHTML = payments.map(payment => `
                    <div class="payment-item">
                        <div>
                            <strong>${payment.payer}</strong> - ${payment.description}: 
                            <strong>Â¥${payment.amount.toLocaleString()}</strong>
                        </div>
                        <button class="delete-btn" onclick="removePayment(${payment.id})">å‰Šé™¤</button>
                    </div>
                `).join('');
                
                calculateSection.style.display = 'block';
            }
        }

        // ç²¾ç®—è¨ˆç®—
        function calculateSettlement() {
            console.log('ç²¾ç®—è¨ˆç®—é–‹å§‹');
            
            if (payments.length === 0) {
                alert('æ”¯æ‰•ã„è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            if (members.size < 2) {
                alert('2äººä»¥ä¸Šã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå¿…è¦ã§ã™');
                return;
            }

            const totalAmount = payments.reduce((sum, p) => sum + p.amount, 0);
            const memberArray = Array.from(members);
            const perPerson = Math.floor(totalAmount / memberArray.length);
            const remainder = totalAmount % memberArray.length;

            console.log('è¨ˆç®—çµæœ:', { totalAmount, memberArray, perPerson, remainder });

            // å„äººã®åæ”¯è¨ˆç®—
            const balances = {};
            memberArray.forEach(member => {
                const paid = payments.filter(p => p.payer === member).reduce((sum, p) => sum + p.amount, 0);
                balances[member] = paid - perPerson;
            });

            // ç«¯æ•°å‡¦ç†ï¼ˆæœ€åˆã®äººãŒè² æ‹…ï¼‰
            if (remainder > 0) {
                const firstMember = memberArray[0];
                balances[firstMember] -= remainder;
            }

            console.log('å„äººã®åæ”¯:', balances);

            // ç²¾ç®—è¨ˆç®—
            const settlements = [];
            const creditors = Object.entries(balances).filter(([_, amount]) => amount > 0);
            const debtors = Object.entries(balances).filter(([_, amount]) => amount < 0);

            creditors.forEach(([creditor, creditAmount]) => {
                debtors.forEach(([debtor, debtAmount]) => {
                    if (creditAmount <= 0 || debtAmount >= 0) return;

                    const transferAmount = Math.min(creditAmount, Math.abs(debtAmount));
                    if (transferAmount > 0) {
                        settlements.push({
                            from: debtor,
                            to: creditor,
                            amount: transferAmount
                        });

                        balances[creditor] -= transferAmount;
                        balances[debtor] += transferAmount;
                        creditAmount -= transferAmount;
                        debtAmount += transferAmount;
                    }
                });
            });

            console.log('ç²¾ç®—çµæœ:', settlements);

            // çµæœè¡¨ç¤º
            displayResult(totalAmount, memberArray.length, perPerson, remainder, settlements);
        }

        // çµæœã‚’è¡¨ç¤º
        function displayResult(totalAmount, memberCount, perPerson, remainder, settlements) {
            const resultSection = document.getElementById('resultSection');
            const totalInfo = document.getElementById('totalInfo');
            const settlementList = document.getElementById('settlementList');

            // ç·é¡æƒ…å ±
            totalInfo.innerHTML = `
                <h3>ğŸ’° åˆè¨ˆé‡‘é¡: Â¥${totalAmount.toLocaleString()}</h3>
                <p>${memberCount}äºº Ã— Â¥${perPerson.toLocaleString()}${remainder > 0 ? ` (+Â¥${remainder})` : ''}</p>
                <p><strong>å‚åŠ è€…:</strong> ${Array.from(members).join(', ')}</p>
            `;

            // ç²¾ç®—ãƒªã‚¹ãƒˆ
            if (settlements.length === 0) {
                settlementList.innerHTML = '<div class="result"><h3>âœ… ç²¾ç®—ä¸è¦ï¼</h3><p>å…¨å“¡ãŒåŒé¡ã‚’æ”¯æ‰•ã„ã¾ã—ãŸ</p></div>';
            } else {
                settlementList.innerHTML = '<h3>ğŸ’¸ ç²¾ç®—å†…å®¹:</h3>' + 
                    settlements.map(settlement => 
                        `<div class="settlement">
                            <strong>${settlement.from}</strong> â†’ <strong>${settlement.to}</strong>: 
                            <strong>Â¥${settlement.amount.toLocaleString()}</strong>
                        </div>`
                    ).join('');
            }

            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
            
            alert('ç²¾ç®—è¨ˆç®—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        }

        // Enterã‚­ãƒ¼ã§è¿½åŠ 
        document.addEventListener('keypress', function(e) {
            if (e.target.tagName === 'INPUT' && e.key === 'Enter') {
                addPayment();
            }
        });

        // åˆæœŸåŒ–ç¢ºèª
        console.log('ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
    </script>
</body>
</html>
