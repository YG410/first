<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シンプル割り勘計算機</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        .payment-item {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-btn {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        .result {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .settlement {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧮 シンプル割り勘計算機</h1>
        
        <!-- 入力フォーム -->
        <div class="form-group">
            <label for="payerName">支払った人:</label>
            <input type="text" id="payerName" placeholder="例: 田中">
        </div>
        
        <div class="form-group">
            <label for="description">内容:</label>
            <input type="text" id="description" placeholder="例: ランチ代">
        </div>
        
        <div class="form-group">
            <label for="amount">金額:</label>
            <input type="number" id="amount" placeholder="例: 3000">
        </div>
        
        <button onclick="addPayment()">支払いを追加</button>
        <button onclick="clearAll()">全て削除</button>
        
        <!-- 支払い一覧 -->
        <h2>📝 支払い記録</h2>
        <div id="paymentsList">
            <div class="empty">まだ支払い記録がありません</div>
        </div>
        
        <!-- 計算ボタン -->
        <div id="calculateSection" style="display: none;">
            <button onclick="calculateSettlement()" style="background-color: #28a745; font-size: 18px; padding: 15px 30px;">
                💰 精算を計算する
            </button>
        </div>
        
        <!-- 結果表示 -->
        <div id="resultSection" style="display: none;">
            <h2>💎 精算結果</h2>
            <div id="totalInfo" class="result"></div>
            <div id="settlementList"></div>
        </div>
    </div>

    <script>
        // グローバル変数
        let payments = [];
        let members = new Set();

        // 支払いを追加する関数
        function addPayment() {
            console.log('addPayment関数が呼ばれました');
            
            const payerName = document.getElementById('payerName').value.trim();
            const description = document.getElementById('description').value.trim();
            const amount = parseInt(document.getElementById('amount').value);

            console.log('入力値:', { payerName, description, amount });

            // 入力チェック
            if (!payerName) {
                alert('支払った人の名前を入力してください');
                return;
            }
            
            if (!description) {
                alert('内容を入力してください');
                return;
            }
            
            if (!amount || amount <= 0 || isNaN(amount)) {
                alert('正しい金額を入力してください');
                return;
            }

            // 支払い記録を作成
            const payment = {
                id: Date.now(),
                payer: payerName,
                description: description,
                amount: amount
            };

            // 配列に追加
            payments.push(payment);
            members.add(payerName);

            console.log('支払い追加:', payment);
            console.log('現在の支払い一覧:', payments);

            // フォームをクリア
            document.getElementById('payerName').value = '';
            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';

            // 画面を更新
            updateDisplay();
            
            alert('支払いを追加しました！');
        }

        // 支払いを削除する関数
        function removePayment(paymentId) {
            console.log('削除ID:', paymentId);
            
            payments = payments.filter(p => p.id !== paymentId);
            
            // メンバーリストを再構築
            members.clear();
            payments.forEach(p => members.add(p.payer));
            
            console.log('削除後の支払い一覧:', payments);
            
            updateDisplay();
            alert('支払いを削除しました');
        }

        // 全ての記録を削除
        function clearAll() {
            if (confirm('全ての記録を削除しますか？')) {
                payments = [];
                members.clear();
                updateDisplay();
                alert('全ての記録を削除しました');
            }
        }

        // 画面表示を更新
        function updateDisplay() {
            console.log('updateDisplay関数が呼ばれました');
            
            const paymentsList = document.getElementById('paymentsList');
            const calculateSection = document.getElementById('calculateSection');
            const resultSection = document.getElementById('resultSection');
            
            // 支払い一覧を更新
            if (payments.length === 0) {
                paymentsList.innerHTML = '<div class="empty">まだ支払い記録がありません</div>';
                calculateSection.style.display = 'none';
                resultSection.style.display = 'none';
            } else {
                paymentsList.innerHTML = payments.map(payment => `
                    <div class="payment-item">
                        <div>
                            <strong>${payment.payer}</strong> - ${payment.description}: 
                            <strong>¥${payment.amount.toLocaleString()}</strong>
                        </div>
                        <button class="delete-btn" onclick="removePayment(${payment.id})">削除</button>
                    </div>
                `).join('');
                
                calculateSection.style.display = 'block';
            }
        }

        // 精算計算
        function calculateSettlement() {
            console.log('精算計算開始');
            
            if (payments.length === 0) {
                alert('支払い記録がありません');
                return;
            }

            if (members.size < 2) {
                alert('2人以上のメンバーが必要です');
                return;
            }

            const totalAmount = payments.reduce((sum, p) => sum + p.amount, 0);
            const memberArray = Array.from(members);
            const perPerson = Math.floor(totalAmount / memberArray.length);
            const remainder = totalAmount % memberArray.length;

            console.log('計算結果:', { totalAmount, memberArray, perPerson, remainder });

            // 各人の収支計算
            const balances = {};
            memberArray.forEach(member => {
                const paid = payments.filter(p => p.payer === member).reduce((sum, p) => sum + p.amount, 0);
                balances[member] = paid - perPerson;
            });

            // 端数処理（最初の人が負担）
            if (remainder > 0) {
                const firstMember = memberArray[0];
                balances[firstMember] -= remainder;
            }

            console.log('各人の収支:', balances);

            // 精算計算
            const settlements = [];
            const creditors = Object.entries(balances).filter(([_, amount]) => amount > 0);
            const debtors = Object.entries(balances).filter(([_, amount]) => amount < 0);

            creditors.forEach(([creditor, creditAmount]) => {
                debtors.forEach(([debtor, debtAmount]) => {
                    if (creditAmount <= 0 || debtAmount >= 0) return;

                    const transferAmount = Math.min(creditAmount, Math.abs(debtAmount));
                    if (transferAmount > 0) {
                        settlements.push({
                            from: debtor,
                            to: creditor,
                            amount: transferAmount
                        });

                        balances[creditor] -= transferAmount;
                        balances[debtor] += transferAmount;
                        creditAmount -= transferAmount;
                        debtAmount += transferAmount;
                    }
                });
            });

            console.log('精算結果:', settlements);

            // 結果表示
            displayResult(totalAmount, memberArray.length, perPerson, remainder, settlements);
        }

        // 結果を表示
        function displayResult(totalAmount, memberCount, perPerson, remainder, settlements) {
            const resultSection = document.getElementById('resultSection');
            const totalInfo = document.getElementById('totalInfo');
            const settlementList = document.getElementById('settlementList');

            // 総額情報
            totalInfo.innerHTML = `
                <h3>💰 合計金額: ¥${totalAmount.toLocaleString()}</h3>
                <p>${memberCount}人 × ¥${perPerson.toLocaleString()}${remainder > 0 ? ` (+¥${remainder})` : ''}</p>
                <p><strong>参加者:</strong> ${Array.from(members).join(', ')}</p>
            `;

            // 精算リスト
            if (settlements.length === 0) {
                settlementList.innerHTML = '<div class="result"><h3>✅ 精算不要！</h3><p>全員が同額を支払いました</p></div>';
            } else {
                settlementList.innerHTML = '<h3>💸 精算内容:</h3>' + 
                    settlements.map(settlement => 
                        `<div class="settlement">
                            <strong>${settlement.from}</strong> → <strong>${settlement.to}</strong>: 
                            <strong>¥${settlement.amount.toLocaleString()}</strong>
                        </div>`
                    ).join('');
            }

            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
            
            alert('精算計算が完了しました！');
        }

        // Enterキーで追加
        document.addEventListener('keypress', function(e) {
            if (e.target.tagName === 'INPUT' && e.key === 'Enter') {
                addPayment();
            }
        });

        // 初期化確認
        console.log('スクリプト読み込み完了');
    </script>
</body>
</html>
